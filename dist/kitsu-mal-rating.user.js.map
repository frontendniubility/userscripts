{"version":3,"file":"kitsu-mal-rating.user.js","mappings":"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","sources":["webpack://userscripts/./src/kitsu-mal-rating/kitsu-mal-rating.user.js"],"sourcesContent":["// ==UserScript==\r\n// @name         Kitsu MAL Rating\r\n// @namespace    http://fuzetsu.com/kitsu-mal-rating\r\n// @version      2.3\r\n// @description  Shows MyAnimeList.net rating on Kitsu.io\r\n// @author       synthtech / fuzetsu\r\n// @match        *://kitsu.io/*\r\n// @require      https://greasyfork.org/scripts/5679-wait-for-elements/code/Wait%20For%20Elements.js?version=147465\r\n// @grant        GM_xmlhttpRequest\r\n// ==/UserScript==\r\n\r\n(function() {\r\n  'use strict';\r\n\r\n  var SCRIPT_NAME = 'Kitsu MAL Rating';\r\n  var API = 'https://kitsu.io/api/edge';\r\n  var REGEX = /^https?:\\/\\/kitsu\\.io\\/(anime|manga)\\/([^\\/]+)\\/?(?:\\?.*)?$/;\r\n\r\n  var Util = {\r\n    log: function() {\r\n      var args = [].slice.call(arguments);\r\n      args.unshift('%c' + SCRIPT_NAME + ':', 'font-weight: bold;color: #233c7b;');\r\n      console.log.apply(console, args);\r\n    },\r\n    q: function(query, context) {\r\n      return (context || document).querySelector(query);\r\n    },\r\n    qq: function(query, context) {\r\n      return [].slice.call((context || document).querySelectorAll(query));\r\n    }\r\n  };\r\n\r\n  var App = {\r\n    cache: {},\r\n    getMalLink: function(type, slug, cb) {\r\n      var id = type + '/' + slug;\r\n      var self = this;\r\n      if (self.cache.hasOwnProperty(id)) {\r\n        Util.log('Loading cached MAL ID:', self.cache[id]);\r\n        cb(self.cache[id]);\r\n      } else {\r\n        Util.log('Fetching mappings for Kitsu slug:', id);\r\n        GM_xmlhttpRequest({\r\n          method: 'GET',\r\n          url: API + '/' + type + '?filter[slug]=' + slug + '&fields[' + type + ']=id&include=mappings',\r\n          headers: {\r\n            'Accept': 'application/vnd.api+json'\r\n          },\r\n          onload: function(response) {\r\n            try {\r\n              var json = JSON.parse(response.responseText);\r\n              var malId;\r\n              if (json.included) {\r\n                for (var i = 0; i < json.included.length; i++) {\r\n                  if (json.included[i].attributes.externalSite == ('myanimelist/' + type)) {\r\n                    malId = json.included[i].attributes.externalId;\r\n                  }\r\n                }\r\n              }\r\n              self.cache[id] = malId;\r\n              cb(malId);\r\n            } catch (err) {\r\n              Util.log('Failed to parse API results');\r\n            }\r\n          },\r\n          onerror: function() {\r\n            Util.log('Failed to get Kitsu mappings');\r\n          }\r\n        });\r\n      }\r\n    },\r\n    getMalPage: function(url, cb) {\r\n      Util.log('Loading MAL page:', url);\r\n      GM_xmlhttpRequest({\r\n        method: 'GET',\r\n        url: url,\r\n        onload: function(response) {\r\n          try {\r\n            var tempDiv = document.createElement('div');\r\n            tempDiv.innerHTML = response.responseText;\r\n\r\n            var sidebar = Util.q('#content > table > tbody > tr > td.borderClass', tempDiv);\r\n            var rating = Util.q('span[itemprop=\"ratingValue\"]', sidebar);\r\n            var headerNum;\r\n\r\n            if (Util.q('h2.mt8', sidebar)) headerNum = 4;\r\n            else headerNum = 3;\r\n\r\n            if (rating) {\r\n              rating = rating.innerText;\r\n            } else {\r\n              var score = Util.q('h2:nth-of-type(' + headerNum + ') + div', sidebar).innerText.replace(/[\\n\\r]/g, '');\r\n              if (score.match(/Score:\\s+N\\/A/)) {\r\n                rating = null;\r\n              } else {\r\n                rating = score.match(/[0-9]{1,2}\\.[0-9]{2}/)[0];\r\n              }\r\n            }\r\n\r\n            cb(rating);\r\n          } catch (err) {\r\n            Util.log('Failed to parse MAL page');\r\n          }\r\n        },\r\n        onerror: function() {\r\n          Util.log('Error loading MAL page');\r\n        }\r\n      });\r\n    }\r\n  };\r\n\r\n  waitForUrl(REGEX, function() {\r\n    var type = location.href.match(REGEX)[1];\r\n    var slug = location.href.match(REGEX)[2];\r\n    var preMalBarCheck = Util.q('#mal-rating-bar');\r\n\r\n    App.getMalLink(type, slug, function(malId) {\r\n      if (!malId) {\r\n        Util.log('MAL ID not found');\r\n        if (preMalBarCheck) preMalBarCheck.remove();\r\n      } else {\r\n        var malLink = 'https://myanimelist.net/' + type + '/' + malId;\r\n\r\n        App.getMalPage(malLink, function(rating) {\r\n          if (!rating || rating == 'N/A') { rating = null; }\r\n          else { rating = parseFloat(rating * 10).toFixed(2); }\r\n\r\n          var malBarCheck = Util.q('#mal-rating-bar');\r\n          if (malBarCheck) {\r\n            var updateRating = malBarCheck.firstChild;\r\n            updateRating.className = 'media-community-rating';\r\n\r\n            if (rating) {\r\n              var percentColor = 'percent-quarter-';\r\n              if (rating <= 25) { percentColor += 1; }\r\n              else if (rating <= 50) { percentColor += 2; }\r\n              else if (rating <= 75) { percentColor += 3; }\r\n              else if (rating <= 100) { percentColor += 4; }\r\n              updateRating.classList.add(percentColor);\r\n            }\r\n\r\n            updateRating.firstChild.href = malLink;\r\n            rating ? updateRating.firstChild.textContent = rating + '% MAL Approval' : updateRating.firstChild.textContent = 'Unknown MAL Approval';\r\n          } else {\r\n            var newRatingBar = document.createElement('section');\r\n            newRatingBar.id = 'mal-rating-bar';\r\n            newRatingBar.className = 'media-rating';\r\n\r\n            var ratingElem = document.createElement('span');\r\n            ratingElem.className = 'media-community-rating';\r\n\r\n            if (rating) {\r\n              var percentColor = 'percent-quarter-';\r\n              if (rating <= 25) { percentColor += 1; }\r\n              else if (rating <= 50) { percentColor += 2; }\r\n              else if (rating <= 75) { percentColor += 3; }\r\n              else if (rating <= 100) { percentColor += 4; }\r\n              ratingElem.classList.add(percentColor);\r\n            }\r\n\r\n            var ratingLink = document.createElement('a');\r\n            ratingLink.id = 'mal-rating-link';\r\n            ratingLink.href = malLink;\r\n            ratingLink.target = '_blank';\r\n            ratingLink.rel = 'noopener noreferrer';\r\n            ratingLink.style.color = 'inherit';\r\n            ratingLink.style.fontFamily = 'inherit';\r\n            rating ? ratingLink.textContent = rating + '% MAL Approval' : ratingLink.textContent = 'Unknown MAL Approval';\r\n\r\n            ratingElem.appendChild(ratingLink);\r\n            newRatingBar.appendChild(ratingElem);\r\n\r\n            waitForElems({\r\n              sel: '.media-rating:not(#mal-rating-bar)',\r\n              stop: true,\r\n              onmatch: function(node) {\r\n                node.parentNode.insertBefore(newRatingBar, node.nextSibling);\r\n              }\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n  });\r\n})();\r\n"],"names":["SCRIPT_NAME","API","REGEX","Util","log","args","slice","call","arguments","unshift","console","apply","q","query","context","document","querySelector","qq","querySelectorAll","App","cache","getMalLink","type","slug","cb","id","self","hasOwnProperty","GM_xmlhttpRequest","method","url","headers","onload","response","json","JSON","parse","responseText","malId","included","i","length","attributes","externalSite","externalId","err","onerror","getMalPage","tempDiv","createElement","innerHTML","sidebar","rating","headerNum","innerText","score","replace","match","waitForUrl","location","href","preMalBarCheck","remove","malLink","parseFloat","toFixed","malBarCheck","updateRating","firstChild","className","percentColor","classList","add","textContent","newRatingBar","ratingElem","ratingLink","target","rel","style","color","fontFamily","appendChild","waitForElems","sel","stop","onmatch","node","parentNode","insertBefore","nextSibling"],"sourceRoot":""}