{"version":3,"file":"kitsu-mal-rating.user.js","mappings":"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","sources":["webpack://userscripts/./src/kitsu-mal-rating/kitsu-mal-rating.user.js"],"sourcesContent":["// ==UserScript==\r\n// @name         Kitsu MAL Rating\r\n// @namespace    http://fuzetsu.com/kitsu-mal-rating\r\n// @version      2.3\r\n// @description  Shows MyAnimeList.net rating on Kitsu.io\r\n// @author       synthtech / fuzetsu\r\n// @match        *://kitsu.io/*\r\n// @require      https://greasyfork.org/scripts/5679-wait-for-elements/code/Wait%20For%20Elements.js?version=147465\r\n// @grant        GM_xmlhttpRequest\r\n// ==/UserScript==\r\n\r\n(function() {\r\n  'use strict';\r\n\r\n  var SCRIPT_NAME = 'Kitsu MAL Rating';\r\n  var API = 'https://kitsu.io/api/edge';\r\n  var REGEX = /^https?:\\/\\/kitsu\\.io\\/(anime|manga)\\/([^\\/]+)\\/?(?:\\?.*)?$/;\r\n\r\n  var Util = {\r\n    log: function() {\r\n      var args = [].slice.call(arguments);\r\n      args.unshift('%c' + SCRIPT_NAME + ':', 'font-weight: bold;color: #233c7b;');\r\n      console.log.apply(console, args);\r\n    },\r\n    q: function(query, context) {\r\n      return (context || document).querySelector(query);\r\n    },\r\n    qq: function(query, context) {\r\n      return [].slice.call((context || document).querySelectorAll(query));\r\n    }\r\n  };\r\n\r\n  var App = {\r\n    cache: {},\r\n    getMalLink: function(type, slug, cb) {\r\n      var id = type + '/' + slug;\r\n      var self = this;\r\n      if (self.cache.hasOwnProperty(id)) {\r\n        Util.log('Loading cached MAL ID:', self.cache[id]);\r\n        cb(self.cache[id]);\r\n      } else {\r\n        Util.log('Fetching mappings for Kitsu slug:', id);\r\n        GM_xmlhttpRequest({\r\n          method: 'GET',\r\n          url: API + '/' + type + '?filter[slug]=' + slug + '&fields[' + type + ']=id&include=mappings',\r\n          headers: {\r\n            'Accept': 'application/vnd.api+json'\r\n          },\r\n          onload: function(response) {\r\n            try {\r\n              var json = JSON.parse(response.responseText);\r\n              var malId;\r\n              if (json.included) {\r\n                for (var i = 0; i < json.included.length; i++) {\r\n                  if (json.included[i].attributes.externalSite == ('myanimelist/' + type)) {\r\n                    malId = json.included[i].attributes.externalId;\r\n                  }\r\n                }\r\n              }\r\n              self.cache[id] = malId;\r\n              cb(malId);\r\n            } catch (err) {\r\n              Util.log('Failed to parse API results');\r\n            }\r\n          },\r\n          onerror: function() {\r\n            Util.log('Failed to get Kitsu mappings');\r\n          }\r\n        });\r\n      }\r\n    },\r\n    getMalPage: function(url, cb) {\r\n      Util.log('Loading MAL page:', url);\r\n      GM_xmlhttpRequest({\r\n        method: 'GET',\r\n        url: url,\r\n        onload: function(response) {\r\n          try {\r\n            var tempDiv = document.createElement('div');\r\n            tempDiv.innerHTML = response.responseText;\r\n\r\n            var sidebar = Util.q('#content > table > tbody > tr > td.borderClass', tempDiv);\r\n            var rating = Util.q('span[itemprop=\"ratingValue\"]', sidebar);\r\n            var headerNum;\r\n\r\n            if (Util.q('h2.mt8', sidebar)) headerNum = 4;\r\n            else headerNum = 3;\r\n\r\n            if (rating) {\r\n              rating = rating.innerText;\r\n            } else {\r\n              var score = Util.q('h2:nth-of-type(' + headerNum + ') + div', sidebar).innerText.replace(/[\\n\\r]/g, '');\r\n              if (score.match(/Score:\\s+N\\/A/)) {\r\n                rating = null;\r\n              } else {\r\n                rating = score.match(/[0-9]{1,2}\\.[0-9]{2}/)[0];\r\n              }\r\n            }\r\n\r\n            cb(rating);\r\n          } catch (err) {\r\n            Util.log('Failed to parse MAL page');\r\n          }\r\n        },\r\n        onerror: function() {\r\n          Util.log('Error loading MAL page');\r\n        }\r\n      });\r\n    }\r\n  };\r\n\r\n  waitForUrl(REGEX, function() {\r\n    var type = location.href.match(REGEX)[1];\r\n    var slug = location.href.match(REGEX)[2];\r\n    var preMalBarCheck = Util.q('#mal-rating-bar');\r\n\r\n    App.getMalLink(type, slug, function(malId) {\r\n      if (!malId) {\r\n        Util.log('MAL ID not found');\r\n        if (preMalBarCheck) preMalBarCheck.remove();\r\n      } else {\r\n        var malLink = 'https://myanimelist.net/' + type + '/' + malId;\r\n\r\n        App.getMalPage(malLink, function(rating) {\r\n          if (!rating || rating == 'N/A') { rating = null; }\r\n          else { rating = parseFloat(rating * 10).toFixed(2); }\r\n\r\n          var malBarCheck = Util.q('#mal-rating-bar');\r\n          if (malBarCheck) {\r\n            var updateRating = malBarCheck.firstChild;\r\n            updateRating.className = 'media-community-rating';\r\n\r\n            if (rating) {\r\n              var percentColor = 'percent-quarter-';\r\n              if (rating <= 25) { percentColor += 1; }\r\n              else if (rating <= 50) { percentColor += 2; }\r\n              else if (rating <= 75) { percentColor += 3; }\r\n              else if (rating <= 100) { percentColor += 4; }\r\n              updateRating.classList.add(percentColor);\r\n            }\r\n\r\n            updateRating.firstChild.href = malLink;\r\n            rating ? updateRating.firstChild.textContent = rating + '% MAL Approval' : updateRating.firstChild.textContent = 'Unknown MAL Approval';\r\n          } else {\r\n            var newRatingBar = document.createElement('section');\r\n            newRatingBar.id = 'mal-rating-bar';\r\n            newRatingBar.className = 'media-rating';\r\n\r\n            var ratingElem = document.createElement('span');\r\n            ratingElem.className = 'media-community-rating';\r\n\r\n            if (rating) {\r\n              var percentColor = 'percent-quarter-';\r\n              if (rating <= 25) { percentColor += 1; }\r\n              else if (rating <= 50) { percentColor += 2; }\r\n              else if (rating <= 75) { percentColor += 3; }\r\n              else if (rating <= 100) { percentColor += 4; }\r\n              ratingElem.classList.add(percentColor);\r\n            }\r\n\r\n            var ratingLink = document.createElement('a');\r\n            ratingLink.id = 'mal-rating-link';\r\n            ratingLink.href = malLink;\r\n            ratingLink.target = '_blank';\r\n            ratingLink.rel = 'noopener noreferrer';\r\n            ratingLink.style.color = 'inherit';\r\n            ratingLink.style.fontFamily = 'inherit';\r\n            rating ? ratingLink.textContent = rating + '% MAL Approval' : ratingLink.textContent = 'Unknown MAL Approval';\r\n\r\n            ratingElem.appendChild(ratingLink);\r\n            newRatingBar.appendChild(ratingElem);\r\n\r\n            waitForElems({\r\n              sel: '.media-rating:not(#mal-rating-bar)',\r\n              stop: true,\r\n              onmatch: function(node) {\r\n                node.parentNode.insertBefore(newRatingBar, node.nextSibling);\r\n              }\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n  });\r\n})();\r\n"],"names":["SCRIPT_NAME","API","REGEX","Util","log","args","slice","call","arguments","unshift","console","apply","q","query","context","document","querySelector","qq","querySelectorAll","App","cache","getMalLink","type","slug","cb","id","self","this","hasOwnProperty","GM_xmlhttpRequest","method","url","headers","onload","response","json","JSON","parse","responseText","malId","included","i","length","attributes","externalSite","externalId","err","onerror","getMalPage","tempDiv","createElement","innerHTML","sidebar","rating","headerNum","innerText","score","replace","match","waitForUrl","location","href","preMalBarCheck","remove","malLink","parseFloat","toFixed","malBarCheck","updateRating","firstChild","className","percentColor","classList","add","textContent","newRatingBar","ratingElem","ratingLink","target","rel","style","color","fontFamily","appendChild","waitForElems","sel","stop","onmatch","node","parentNode","insertBefore","nextSibling"],"sourceRoot":""}