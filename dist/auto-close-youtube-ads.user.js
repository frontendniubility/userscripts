// ==UserScript==
// @name        Auto Close YouTube Ads
// @version     2023.228.5144344
// @author      fuzetsu
// @description Close and/or Mute YouTube ads automatically!
// @homepage    https://github.com/niubilityfrontend/userscripts#readme
// @supportURL  https://github.com/niubilityfrontend/userscripts/issues
// @match       *://*.youtube.com/*
// @namespace   http://fuzetsu.acypa.com
// @exclude     *://*.youtube.com/subscribe_embed?*
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_deleteValue
// @grant       GM_registerMenuCommand
// @require     https://gitcdn.xyz/repo/fuzetsu/userscripts/b38eabf72c20fa3cf7da84ecd2cefe0d4a2116be/wait-for-elements/wait-for-elements.js
// @require     https://gitcdn.xyz/repo/kufii/My-UserScripts/fa4555701cf5a22eae44f06d9848df6966788fa8/libs/gm_config.js
// @downloadURL https://gitee.com/tsharp/userscripts/raw/master/dist/auto-close-youtube-ads.user.js
// @updateURL   https://gitee.com/tsharp/userscripts/raw/master/dist/auto-close-youtube-ads.meta.js
// ==/UserScript==

(()=>{function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}var t={skipButton:".videoAdUiSkipButton,.ytp-ad-skip-button",preSkipButton:".videoAdUiPreSkipButton,.ytp-ad-preview-container",closeBannerAd:".close-padding.contains-svg,a.close-button,.ytp-ad-overlay-close-button",muteButton:".ytp-mute-button",muteIndicator:".ytp-volume-slider-handle",adArea:".videoAdUi,.ytp-ad-player-overlay",adLength:".videoAdUiAttribution,.ytp-ad-duration-remaining",homeAdContainer:"#masthead-ad"},n={log:function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=console).log.apply(e,["%c".concat(o,":"),"font-weight: bold;color: purple;"].concat(n))},clearTicks:function(e){e.forEach((function(e){return e?"number"==typeof e?clearInterval(e):e.stop():null})),e.length=0},keepTrying:function(e,t){var n=setInterval((function(){return t()&&clearInterval(n)}),e);return n},storeGet:function(e){if("undefined"==typeof GM_getValue){var t=localStorage.getItem(e);return"true"===t||"false"!==t&&t}return GM_getValue(e)},storeSet:function(e,t){return"undefined"==typeof GM_setValue?localStorage.setItem(e,t):GM_setValue(e,t)},storeDel:function(e){return"undefined"==typeof GM_deleteValue?localStorage.removeItem(e):GM_deleteValue(e)},q:function(e,t){return(t||document).querySelector(e)},qq:function(e,t){return Array.from((t||document).querySelectorAll(e))},get:function(e,t){return n.getPath(e,t.split(".").reverse())},getPath:function(e,t){return null==e?null:t.length>0?n.getPath(e[t.pop()],t):e}},o="Auto Close YouTube Ads",r=12e3,i=[],a=!1,u=GM_config([{key:"muteAd",label:"Mute ads?",type:"bool",default:!0},{key:"hideAd",label:"Hide video ads?",type:"bool",default:!1},{key:"secWaitBanner",label:"Banner ad close delay (seconds)",type:"number",default:3,min:0},{key:"secWaitVideo",label:"Video ad skip delay (seconds)",type:"number",default:3,min:0},{key:"minAdLengthForSkip",label:"Dont skip video shorter than this (seconds)",type:"number",default:0,min:0},{key:"muteEvenIfNotSkipping",label:"Mute video even if not skipping",type:"bool",default:!0},{key:"debug",label:"Show extra debug information.",type:"bool",default:!1},{key:"version",type:"hidden",default:1}]),l=u.load();function d(){var e=document.createElement("div");return e.setAttribute("style","border: 1px solid white;border-right: none;background: rgb(0,0,0,0.75);color:white;position: absolute;right: 0;z-index: 1000;top: 10px;padding: 10px;padding-right: 20px;cursor: pointer;pointer-events: all;"),e}function c(e,t,o){var r=d();r.textContent=t,e.appendChild(r),n.log("showing message [".concat(o,"ms]: ").concat(t)),setTimeout((function(){return r.remove()}),o)}u.onsave=function(e){return l=e},function(){for(var e;l.version<2&&e!==l.version;)if(n.log("upgrading config version, current = ",l.version,", target = ",2),e=l.version,1===l.version){var t={muteAd:n.storeGet("MUTE_AD"),hideAd:n.storeGet("HIDE_AD"),secWait:n.storeGet("SEC_WAIT")};null!=t.muteAd&&(l.muteAd=!!t.muteAd),null!=t.hideAd&&(l.hideAd=!!t.hideAd),null==t.secWait||isNaN(t.secWait)||(l.secWaitBanner=l.secWaitVideo=parseInt(t.secWait)),l.version=2,u.save(l),["SEC_WAIT","HIDE_AD","MUTE_AD"].forEach(n.storeDel)}}();var s=function(){return n.q(t.muteButton)},f=function(){return n.q(t.muteIndicator)},p=function(e){return"0px"===e.style.left};function g(o){if(!o)return 0;var r,i,a,u,l,d,c=o.querySelector(t.adLength);return c?(r=c.textContent,l=r.split(" ").pop().split(":").map((function(e){return parseInt(e)})),d=2,a=(i=function(e){if(Array.isArray(e))return e}(l)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,r,i,a,u=[],l=!0,d=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(o=i.call(n)).done)&&(u.push(o.value),u.length!==t);l=!0);}catch(e){d=!0,r=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(d)throw r}}return u}}(l,d)||function(t,n){if(t){if("string"==typeof t)return e(t,n);var o=Object.prototype.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?e(t,n):void 0}}(l,d)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())[0],u=i[1],n.log(r,a,u),60*a+u||0):0}function m(){a=!1,i.push(waitForElems({sel:t.skipButton,onmatch:function(e){n.log("found skip button"),n.keepTrying(500,(function(){return!e||(null!==e.offsetParent?(setTimeout((function(){if(a)return n.log("not skipping..."),void(a=!1);n.log("clicking skip button"),e.click()}),1e3*l.secWaitVideo),!0):void 0)}))}}),y(t.closeBannerAd,1e3*l.secWaitBanner),waitForElems({sel:t.adArea,onmatch:function(e){a=!1;var o=g(e),i=o<l.minAdLengthForSkip,u=function(){return l.debug?"[DEBUG adLength = ".concat(o,", minAdLengthForSkip = ").concat(l.minAdLengthForSkip,"]"):""};if(i&&!l.muteEvenIfNotSkipping)return a=!0,c(e,"Shot AD detected, will not skip or mute. ".concat(u()),r);if(l.hideAd&&(e.style.zIndex=10,e.style.background="black"),i||function(e){var o=n.q(t.preSkipButton,e),r=o&&o.textContent.trim().replace(/\s+/g," ");if(r&&!["will begin","will play"].some((function(e){return r.includes(e)}))){var i="acya-cancel-skip",u=n.q("."+i);u&&u.remove(),(u=d()).className=i,u.textContent=(l.muteAd?"Un-mute & ":"")+"Cancel Auto Skip",u.onclick=function(){n.log("cancel clicked"),a=!0,u.remove();var e=s(),t=f();l.muteAd&&e&&t&&p(t)&&e.click()},e.appendChild(u)}else n.log("skip button area wasn't there for some reason.. couldn't place cancel button.")}(e),l.muteAd){var m=s(),v=f();return v?(m.click(),n.log("Video ad detected, muting audio"),n.keepTrying(250,(function(){if(!n.q(t.adArea))return p(v)?(m.click(),n.log("Video ad ended, unmuting audio")):n.log("Video ad ended, audio already unmuted"),!0})),i?(a=!0,c(e,"Short AD detected, will not skip but will mute. ".concat(u()),r)):void 0):n.log("unable to determine mute state, skipping mute")}}}))}var v,y=function(e,t,o){return waitForElems({sel:e,onmatch:function(e){n.log("Found ad, closing in",t,"ms"),setTimeout((function(){e.click(),o&&o(e)}),t)}})};n.log("Started"),window.self===window.top?(waitForElems({sel:t.homeAdContainer,onmatch:function(e){return e.remove()}}),waitForUrl(/^https:\/\/www\.youtube\.com\/watch\?.*v=.+/,(function(){v&&location.href!==v&&(n.log("Changed video, removing old wait"),n.clearTicks(i)),v=location.href,n.log("Entered video, waiting for ads"),m(),i.push(waitForUrl((function(e){return e!==v}),(function(){v=null,n.clearTicks(i),n.log("Left video, stopped waiting for ads")}),!0))}))):/^https:\/\/www\.youtube\.com\/embed\//.test(location.href)&&(n.log("Found embedded video, waiting for ads"),m()),GM_registerMenuCommand("Auto Close Youtube Ads - Manage Settings",u.setup)})();
//# sourceMappingURL=auto-close-youtube-ads.user.js.map