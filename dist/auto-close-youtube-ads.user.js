// ==UserScript==
// @name        Auto Close YouTube Ads
// @version     2023.301.5132113
// @author      fuzetsu
// @description Close and/or Mute YouTube ads automatically!
// @homepage    https://gitee.com/tsharp/userscripts#readme
// @supportURL  https://gitee.com/tsharp/userscripts/issues
// @match       *://*.youtube.com/*
// @namespace   http://fuzetsu.acypa.com
// @exclude     *://*.youtube.com/subscribe_embed?*
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_deleteValue
// @grant       GM_registerMenuCommand
// @require     https://gitcdn.xyz/repo/fuzetsu/userscripts/b38eabf72c20fa3cf7da84ecd2cefe0d4a2116be/wait-for-elements/wait-for-elements.js
// @require     https://gitcdn.xyz/repo/kufii/My-UserScripts/fa4555701cf5a22eae44f06d9848df6966788fa8/libs/gm_config.js
// @downloadURL https://gitee.com/tsharp/userscripts/raw/master/dist/auto-close-youtube-ads.user.js
// @updateURL   https://gitee.com/tsharp/userscripts/raw/master/dist/auto-close-youtube-ads.meta.js
// ==/UserScript==

(()=>{function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}var t=".videoAdUi,.ytp-ad-player-overlay",n={log:function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=console).log.apply(e,["%c".concat(o,":"),"font-weight: bold;color: purple;"].concat(n))},clearTicks:function(e){e.forEach((function(e){return e?"number"==typeof e?clearInterval(e):e.stop():null})),e.length=0},keepTrying:function(e,t){var n=setInterval((function(){return t()&&clearInterval(n)}),e);return n},storeGet:function(e){if("undefined"==typeof GM_getValue){var t=localStorage.getItem(e);return"true"===t||"false"!==t&&t}return GM_getValue(e)},storeSet:function(e,t){return"undefined"==typeof GM_setValue?localStorage.setItem(e,t):GM_setValue(e,t)},storeDel:function(e){return"undefined"==typeof GM_deleteValue?localStorage.removeItem(e):GM_deleteValue(e)},q:function(e,t){return(t||document).querySelector(e)},qq:function(e,t){return Array.from((t||document).querySelectorAll(e))},get:function(e,t){return n.getPath(e,t.split(".").reverse())},getPath:function(e,t){return null==e?null:t.length>0?n.getPath(e[t.pop()],t):e}},o="Auto Close YouTube Ads",r=[],i=!1,a=GM_config([{key:"muteAd",label:"Mute ads?",type:"bool",default:!0},{key:"hideAd",label:"Hide video ads?",type:"bool",default:!1},{key:"secWaitBanner",label:"Banner ad close delay (seconds)",type:"number",default:3,min:0},{key:"secWaitVideo",label:"Video ad skip delay (seconds)",type:"number",default:3,min:0},{key:"minAdLengthForSkip",label:"Dont skip video shorter than this (seconds)",type:"number",default:0,min:0},{key:"muteEvenIfNotSkipping",label:"Mute video even if not skipping",type:"bool",default:!0},{key:"debug",label:"Show extra debug information.",type:"bool",default:!1},{key:"version",type:"hidden",default:1}]),l=a.load();function u(){var e=document.createElement("div");return e.setAttribute("style","border: 1px solid white;border-right: none;background: rgb(0,0,0,0.75);color:white;position: absolute;right: 0;z-index: 1000;top: 10px;padding: 10px;padding-right: 20px;cursor: pointer;pointer-events: all;"),e}function c(e,t,o){var r=u();r.textContent=t,e.appendChild(r),n.log("showing message [".concat(o,"ms]: ").concat(t)),setTimeout((function(){return r.remove()}),o)}a.onsave=function(e){return l=e},function(){for(var e;l.version<2&&e!==l.version;)if(n.log("upgrading config version, current = ",l.version,", target = ",2),e=l.version,1===l.version){var t={muteAd:n.storeGet("MUTE_AD"),hideAd:n.storeGet("HIDE_AD"),secWait:n.storeGet("SEC_WAIT")};null!=t.muteAd&&(l.muteAd=!!t.muteAd),null!=t.hideAd&&(l.hideAd=!!t.hideAd),null==t.secWait||isNaN(t.secWait)||(l.secWaitBanner=l.secWaitVideo=parseInt(t.secWait)),l.version=2,a.save(l),["SEC_WAIT","HIDE_AD","MUTE_AD"].forEach(n.storeDel)}}();var d=function(){return n.q(".ytp-mute-button")},s=function(){return n.q(".ytp-volume-slider-handle")},f=function(e){return"0px"===e.style.left};function p(t){if(!t)return 0;var o,r,i,a,l,u,c=t.querySelector(".videoAdUiAttribution,.ytp-ad-duration-remaining");return c?(o=c.textContent,l=o.split(" ").pop().split(":").map((function(e){return parseInt(e)})),u=2,i=(r=function(e){if(Array.isArray(e))return e}(l)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,r,i,a,l=[],u=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;u=!1}else for(;!(u=(o=i.call(n)).done)&&(l.push(o.value),l.length!==t);u=!0);}catch(e){c=!0,r=e}finally{try{if(!u&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw r}}return l}}(l,u)||function(t,n){if(t){if("string"==typeof t)return e(t,n);var o=Object.prototype.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?e(t,n):void 0}}(l,u)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())[0],a=r[1],n.log(o,i,a),60*i+a||0):0}function g(){i=!1,r.push(waitForElems({sel:".videoAdUiSkipButton,.ytp-ad-skip-button",onmatch:function(e){n.log("found skip button"),n.keepTrying(500,(function(){return!e||(null!==e.offsetParent?(setTimeout((function(){if(i)return n.log("not skipping..."),void(i=!1);n.log("clicking skip button"),e.click()}),1e3*l.secWaitVideo),!0):void 0)}))}}),v(".close-padding.contains-svg,a.close-button,.ytp-ad-overlay-close-button",1e3*l.secWaitBanner),waitForElems({sel:t,onmatch:function(e){i=!1;var o=p(e),r=o<l.minAdLengthForSkip,a=function(){return l.debug?"[DEBUG adLength = ".concat(o,", minAdLengthForSkip = ").concat(l.minAdLengthForSkip,"]"):""};if(r&&!l.muteEvenIfNotSkipping)return i=!0,c(e,"Shot AD detected, will not skip or mute. ".concat(a()),12e3);if(l.hideAd&&(e.style.zIndex=10,e.style.background="black"),r||function(e){var t=n.q(".videoAdUiPreSkipButton,.ytp-ad-preview-container",e),o=t&&t.textContent.trim().replace(/\s+/g," ");if(o&&!["will begin","will play"].some((function(e){return o.includes(e)}))){var r="acya-cancel-skip",a=n.q("."+r);a&&a.remove(),(a=u()).className=r,a.textContent=(l.muteAd?"Un-mute & ":"")+"Cancel Auto Skip",a.onclick=function(){n.log("cancel clicked"),i=!0,a.remove();var e=d(),t=s();l.muteAd&&e&&t&&f(t)&&e.click()},e.appendChild(a)}else n.log("skip button area wasn't there for some reason.. couldn't place cancel button.")}(e),l.muteAd){var g=d(),m=s();return m?(g.click(),n.log("Video ad detected, muting audio"),n.keepTrying(250,(function(){if(!n.q(t))return f(m)?(g.click(),n.log("Video ad ended, unmuting audio")):n.log("Video ad ended, audio already unmuted"),!0})),r?(i=!0,c(e,"Short AD detected, will not skip but will mute. ".concat(a()),12e3)):void 0):n.log("unable to determine mute state, skipping mute")}}}))}var m,v=function(e,t,o){return waitForElems({sel:e,onmatch:function(e){n.log("Found ad, closing in",t,"ms"),setTimeout((function(){e.click(),o&&o(e)}),t)}})};n.log("Started"),window.self===window.top?(waitForElems({sel:"#masthead-ad",onmatch:function(e){return e.remove()}}),waitForUrl(/^https:\/\/www\.youtube\.com\/watch\?.*v=.+/,(function(){m&&location.href!==m&&(n.log("Changed video, removing old wait"),n.clearTicks(r)),m=location.href,n.log("Entered video, waiting for ads"),g(),r.push(waitForUrl((function(e){return e!==m}),(function(){m=null,n.clearTicks(r),n.log("Left video, stopped waiting for ads")}),!0))}))):/^https:\/\/www\.youtube\.com\/embed\//.test(location.href)&&(n.log("Found embedded video, waiting for ads"),g()),GM_registerMenuCommand("Auto Close Youtube Ads - Manage Settings",a.setup)})();
//# sourceMappingURL=auto-close-youtube-ads.user.js.map