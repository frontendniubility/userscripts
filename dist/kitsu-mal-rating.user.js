// ==UserScript==
// @name        Kitsu MAL Rating
// @version     2023.301.5132113
// @author      synthtech / fuzetsu
// @description Shows MyAnimeList.net rating on Kitsu.io
// @homepage    https://gitee.com/tsharp/userscripts#readme
// @supportURL  https://gitee.com/tsharp/userscripts/issues
// @match       *://kitsu.io/*
// @namespace   http://fuzetsu.com/kitsu-mal-rating
// @require     https://greasyfork.org/scripts/5679-wait-for-elements/code/Wait%20For%20Elements.js?version=147465
// @grant       GM_xmlhttpRequest
// @downloadURL https://gitee.com/tsharp/userscripts/raw/master/dist/kitsu-mal-rating.user.js
// @updateURL   https://gitee.com/tsharp/userscripts/raw/master/dist/kitsu-mal-rating.meta.js
// ==/UserScript==

!function(){"use strict";var e="Kitsu MAL Rating",t=/^https?:\/\/kitsu\.io\/(anime|manga)\/([^\/]+)\/?(?:\?.*)?$/,a=function(){var t=[].slice.call(arguments);t.unshift("%c"+e+":","font-weight: bold;color: #233c7b;"),console.log.apply(console,t)},n=function(e,t){return(t||document).querySelector(e)},r={cache:{},getMalLink:function(e,t,n){var r=e+"/"+t,i=this;i.cache.hasOwnProperty(r)?(a("Loading cached MAL ID:",i.cache[r]),n(i.cache[r])):(a("Fetching mappings for Kitsu slug:",r),GM_xmlhttpRequest({method:"GET",url:"https://kitsu.io/api/edge/"+e+"?filter[slug]="+t+"&fields["+e+"]=id&include=mappings",headers:{Accept:"application/vnd.api+json"},onload:function(t){try{var o,l=JSON.parse(t.responseText);if(l.included)for(var c=0;c<l.included.length;c++)l.included[c].attributes.externalSite=="myanimelist/"+e&&(o=l.included[c].attributes.externalId);i.cache[r]=o,n(o)}catch(e){a("Failed to parse API results")}},onerror:function(){a("Failed to get Kitsu mappings")}}))},getMalPage:function(e,t){a("Loading MAL page:",e),GM_xmlhttpRequest({method:"GET",url:e,onload:function(e){try{var r=document.createElement("div");r.innerHTML=e.responseText;var i,o=n("#content > table > tbody > tr > td.borderClass",r),l=n('span[itemprop="ratingValue"]',o);if(i=n("h2.mt8",o)?4:3,l)l=l.innerText;else{var c=n("h2:nth-of-type("+i+") + div",o).innerText.replace(/[\n\r]/g,"");l=c.match(/Score:\s+N\/A/)?null:c.match(/[0-9]{1,2}\.[0-9]{2}/)[0]}t(l)}catch(e){a("Failed to parse MAL page")}},onerror:function(){a("Error loading MAL page")}})}};waitForUrl(t,(function(){var e=location.href.match(t)[1],i=location.href.match(t)[2],o=n("#mal-rating-bar");r.getMalLink(e,i,(function(t){if(t){var i="https://myanimelist.net/"+e+"/"+t;r.getMalPage(i,(function(e){e=e&&"N/A"!=e?parseFloat(10*e).toFixed(2):null;var t=n("#mal-rating-bar");if(t){var a=t.firstChild;if(a.className="media-community-rating",e){var r="percent-quarter-";e<=25?r+=1:e<=50?r+=2:e<=75?r+=3:e<=100&&(r+=4),a.classList.add(r)}a.firstChild.href=i,a.firstChild.textContent=e?e+"% MAL Approval":"Unknown MAL Approval"}else{var o=document.createElement("section");o.id="mal-rating-bar",o.className="media-rating";var l=document.createElement("span");l.className="media-community-rating",e&&(r="percent-quarter-",e<=25?r+=1:e<=50?r+=2:e<=75?r+=3:e<=100&&(r+=4),l.classList.add(r));var c=document.createElement("a");c.id="mal-rating-link",c.href=i,c.target="_blank",c.rel="noopener noreferrer",c.style.color="inherit",c.style.fontFamily="inherit",c.textContent=e?e+"% MAL Approval":"Unknown MAL Approval",l.appendChild(c),o.appendChild(l),waitForElems({sel:".media-rating:not(#mal-rating-bar)",stop:!0,onmatch:function(e){e.parentNode.insertBefore(o,e.nextSibling)}})}}))}else a("MAL ID not found"),o&&o.remove()}))}))}();
//# sourceMappingURL=kitsu-mal-rating.user.js.map